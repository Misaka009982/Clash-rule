name: Build Rules

on:
  schedule:
    - cron: "58 * * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests ruamel.yaml pyyaml

      - name: Install mihomo
        run: |
          set -e
          echo "Fetching latest mihomo release info..."
          VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r .tag_name)
          URL="https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/mihomo-linux-amd64-compatible-${VERSION}.gz"
          echo "Downloading: $URL"
          curl -L "$URL" -o /usr/local/bin/mihomo.gz
          gunzip /usr/local/bin/mihomo.gz
          chmod +x /usr/local/bin/mihomo
          mihomo -v

      - name: Generate rule lists
        run: |
          python .github/scripts/rules.py

      - name: Convert rules to mrs (in-place)
        run: |
          set -e

          for dir in Rule/*; do
            [ -d "$dir" ] || continue
            echo "Processing $(basename "$dir")"

            # 清理旧 mrs，防止残留
            rm -f "$dir"/*.mrs

            if [ -s "$dir/domains.list" ]; then
              echo "  → domains.list → domains.mrs"
              mihomo convert-ruleset domain text \
                "$dir/domains.list" \
                "$dir/domains.mrs"
            fi

            if [ -s "$dir/ipcidr.list" ]; then
              echo "  → ipcidr.list → ipcidr.mrs"
              mihomo convert-ruleset ipcidr text \
                "$dir/ipcidr.list" \
                "$dir/ipcidr.mrs"
            fi
          done

      - name: Upload Rule artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Clash-Rules
          path: Rule/
